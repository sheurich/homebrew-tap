---
name: Publish bottles

'on':
  workflow_run:
    workflows: ["brew test-bot"]
    types: [completed]

jobs:
  publish:
    # Only publish bottles for successful PR test runs from this repository
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_repository.full_name == github.repository
    runs-on: ubuntu-22.04
    outputs:
      pr_number: ${{ steps.pr.outputs.number }}
      is_bump: ${{ steps.pr.outputs.is_bump }}
    permissions:
      contents: write
      pull-requests: write
      actions: read
    steps:
      - name: Get PR number
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # yamllint disable rule:line-length
        run: |
          PR_NUMBER="$(jq -r 'if (.workflow_run.pull_requests | length) > 0 then .workflow_run.pull_requests[0].number else "" end' "$GITHUB_EVENT_PATH")"
          if [[ -z "${PR_NUMBER}" ]]; then
            echo "No pull request associated with this run."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

          # Check if this is a bump PR for automerge
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          if [[ "${HEAD_BRANCH}" == bump-* ]]; then
            echo "is_bump=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_bump=false" >> "$GITHUB_OUTPUT"
          fi
        # yamllint enable rule:line-length

      - name: Set up Homebrew
        if: steps.pr.outputs.skip != 'true'
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        if: steps.pr.outputs.skip != 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Pull bottles and update formula
        if: steps.pr.outputs.skip != 'true'
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # brew pr-pull handles: download artifacts, upload to release, commit bottle DSL, push to main
        run: |
          brew pr-pull \
            --tap="${{ github.repository }}" \
            --workflows=tests.yml \
            --artifact-pattern="bottles_*" \
            "${{ steps.pr.outputs.number }}"

  automerge:
    needs: publish
    if: needs.publish.outputs.is_bump == 'true'
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.publish.outputs.pr_number }}
        run: |
          gh pr merge "${PR_NUMBER}" \
            --repo "${{ github.repository }}" \
            --squash --delete-branch
